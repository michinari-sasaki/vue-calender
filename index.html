<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/vue@next"></script>
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/reset.css" />
    <title>ゴミの日アプリ</title>
  </head>
  <body>
    <div id="app">
      <header class="header">
        <div class="inner header__inner">
          <h1 class="header__title">ゴミの日カレンダー</h1>
        </div>
      </header>
      <div class="main">
        <section class="calender">
          <div class="inner">
            <div class="calender__setting">
              <h2 class="heading">可燃ゴミ収集日</h2>
              <select v-model="selectedBurn">
                <option v-for="item in weekTypeList" :value="item.type">{{item.val}}</option>
              </select>
              <!-- 変更中 -->
              <template v-for="item,index in this.weekdaysArray" :key="index">
                <button v-on:click="everyWeek(index+1,selectedBurn,'burn',this.isActive[index].on);selectedButton('burn',index)" v-bind:class="{active:this.isActive[index].on}">{{item}}曜日</button>
              </template>
              <!--
              <template v-for="item,index in this.weekdaysArray" :key="index">
                <button v-on:click="everyWeek(index+1,selectedBurn,'burn'); selectedButton('burn',index)" v-bind:class="{active: selected}" :class="['selected_'+index]">{{item}}曜日{{index}}</button>
              </template> -->
              <br />
              <br />
              <h2 class="heading">不燃ゴミ収集日</h2>
              <select v-model="selectedNonBurn">
                <option v-for="item in weekTypeList" :value="item.type">{{item.val}}</option>
              </select>
              <template v-for="item,index in this.weekdaysArray" :key="index">
                <button v-on:click="everyWeek(index+1,selectedNonBurn,'nonBurn',this.isActive_2[index].on);selectedButton('burn',index)" v-bind:class="{active:this.isActive_2[index].on}">{{item}}曜日</button>
              </template>
              <br />
              <br />
              <h2 class="heading">資源ゴミ収集日</h2>
              <select v-model="selectedResource">
                <option v-for="item in weekTypeList" :value="item.type">{{item.val}}</option>
              </select>
              <template v-for="item,index in this.weekdaysArray" :key="index">
                <button v-on:click="everyWeek(index+1,selectedResource,'resource')">{{item}}曜日</button>
              </template>
              <br />
              <br />
              <button v-on:click="saveData()">保存</button>
              <button v-on:click="clearData()">削除</button>
            </div>
            <h2 class="calender__heading">{{currentMonth}}月</h2>
            <ul class="calender__list">
              <li v-for="item in this.dayArray" class="week">{{item}}</li>
              <li v-for="n in this.blankDays">&nbsp;</li>
              <li v-for="(item,index) in this.allDays" :key="index" v-bind:class="item.detail">
                <div class="calender__list__date" v-bind:class="{today:item.today}">{{item.date}}</div>
                <div class="calender__list__detail">
                  <template v-if="item.detail=='burn'">可燃ゴミ</template>
                  <template v-else-if="item.detail=='nonBurn'">不燃ゴミ</template>
                  <template v-if="item.detail=='resource'">資源ゴミ</template>
                </div>
              </li>
            </ul>
          </div>
          <div id="result"></div>
        </section>
      </div>
      <footer class="footer">ゴミの日アプリ</footer>
    </div>
    <script>
      Vue.createApp({
        data: function () {
          return {
            isActive: [{ on: false }, { on: false }, { on: false }, { on: false }, { on: false }, { on: false }, { on: false }],
            isActive_2: [{ on: false }, { on: false }, { on: false }, { on: false }, { on: false }, { on: false }, { on: false }],
            isActive_3: [{ on: false }, { on: false }, { on: false }, { on: false }, { on: false }, { on: false }, { on: false }],
            selectedBurn: null,
            selectedNonBurn: null,
            selectedResource: null,
            startDate: null,
            currentMonth: null,
            toDate: null,
            toDay: null,
            lastDate: null,
            lastDay: null,
            blankDays: null,
            allDays: [],
            weekdaysArray: ["月", "火", "水", "木", "金", "土"],
            dayArray: ["日", "月", "火", "水", "木", "金", "土"],
            weekTypeList: [
              { type: "all", val: "毎週" },
              { type: "odd", val: "第1 | 第3" },
              { type: "even", val: "第2 | 第4" },
            ],
          };
        },
        methods: {
          calender: function () {
            //現在の日付の取得
            const nowDate = new Date();
            const year = nowDate.getFullYear();
            const month = nowDate.getMonth() + 1;
            const date = nowDate.getDate();
            const day = this.dayArray[nowDate.getDay()];
            this.toDate = date;
            this.currentMonth = month;
            console.log("今日の日付：" + year + "年" + month + "月" + date + "日" + day + "曜日");
            //今月の月初の取得
            const startDate = new Date(year, month - 1, 1);
            this.startDate = startDate.getDay();
            //今月の月末の取得
            const lastDate = new Date(year, month, 0);
            this.lastDate = new Date(year, month, 0).getDate();
            this.lastDay = parseInt(lastDate.getDay(), 10);
            this.lastDay = parseInt(this.lastDay, 10);
            this.lastDay = 6 - this.lastDay;
            console.log("月末：" + this.lastDate);
            //オブジェクトに情報を格納
            for (let i = 1; i <= this.lastDate; i++) {
              let oneDay = new Date(year, month - 1, i);
              oneDay = oneDay.getDay();
              if (i == date) {
                this.toDay = true;
              } else {
                this.toDay = false;
              }
              this.allDays.push({ month: month, date: i, day: oneDay, today: this.toDay, detail: null, isActive: false });
            }
            this.blankDays = this.allDays[0].day;
          },
          //毎週のゴミの日指定
          everyWeek: function (index, oddEven, garbageType, isActive) {
            //引数で指定された曜日の日付をforで配列に格納する
            let everyWeek = [];
            for (let i = 0; i <= this.allDays.length - 1; i++) {
              if (this.allDays[i].day == index) {
                everyWeek.push(this.allDays[i].date);
              }
            }
            //毎週以外、奇数日（1,3隔週）偶数日（2,4隔週）なら配列から奇数or偶数番目を削除
            if (oddEven == "even") {
              everyWeek.splice(0, 1);
              everyWeek.splice(1, 1);
              everyWeek.splice(2);
            } else if (oddEven == "odd") {
              everyWeek.splice(1, 1);
              everyWeek.splice(2);
            } else if (oddEven == "all") {
            }
            for (let i = 0; i <= this.allDays.length; i++) {
              if (everyWeek.indexOf(i) >= 0) {
                this.allDays[i - 1].detail = garbageType;
                this.allDays[i - 1].isActive = !isActive;
                if (this.allDays[i - 1].isActive == false) {
                  this.allDays[i - 1].detail = null;
                }
                //console.log(this.allDays[i - 1].isActive);
              }
            }
          },
          selectedButton: function (type, index) {
            console.log(type, index);
            this.isActive[index].on = !this.isActive[index].on;
          },
          saveData: function () {
            const tmp = JSON.stringify(this.allDays);
            localStorage.setItem("tmp", tmp);
          },
          clearData: function () {
            localStorage.clear();
            location.reload();
          },
        },
        mounted: function () {
          //ローカルストレージにkey tmpがあれば
          if (localStorage.hasOwnProperty("tmp")) {
            this.allDays = JSON.parse(localStorage.getItem("tmp"));
            this.blankDays = this.allDays[0].day;
            this.currentMonth = this.allDays[0].month;
          } else {
            this.calender();
          }
        },
      }).mount("#app");
    </script>
  </body>
</html>
